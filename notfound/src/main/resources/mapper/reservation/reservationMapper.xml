<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.office.notfound.reservation.model.dao.ReservationMapper">

    <resultMap id="reservationResultMap" type="com.office.notfound.reservation.model.dto.ReservationDTO">
        <result property="reservationCode" column="reservation_code"/>
        <result property="memberCode" column="member_code"/>
        <result property="storeName" column="storeName"/>
        <result property="startDatetime" column="start_datetime"/>
        <result property="endDatetime" column="end_datetime"/>
        <result property="totalPrice" column="total_price"/>
        <result property="reservationStatus" column="reservation_status"/>
    </resultMap>

    <!-- ðŸ”¹ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžì˜ ì˜ˆì•½ ì „ì²´ ì¡°íšŒ -->
    <select id="findAllReservationByMember" resultMap="reservationResultMap">
        SELECT
            r.reservation_code,
            r.member_code,
            CONCAT(s.store_name, '(', o.office_num, ')') AS storeName,
            r.start_datetime,
            r.end_datetime,
            r.total_price,
            r.reservation_status
        FROM
            tbl_reservation r
                JOIN tbl_office o ON r.office_code = o.office_code
                JOIN tbl_store s ON o.store_code = s.store_code
        WHERE
            r.member_code = #{memberCode}
        ORDER BY
            r.reservation_code DESC;
    </select>

    <!-- ðŸ”¹ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžì˜ íŠ¹ì • ì˜ˆì•½ ê²€ìƒ‰ -->
    <select id="searchReservationByMember" resultMap="reservationResultMap">
        SELECT
        r.reservation_code,
        r.member_code,
        CONCAT(s.store_name, '(', o.office_num, ')') AS storeName,
        r.start_datetime,
        r.end_datetime,
        r.total_price,
        r.reservation_status
        FROM
        tbl_reservation r
        JOIN tbl_office o ON r.office_code = o.office_code
        JOIN tbl_store s ON o.store_code = s.store_code
        WHERE
        r.member_code = #{memberCode}
        <if test="reservationCode != null">
            AND reservation_code = #{reservationCode}
        </if>
        <if test="reservationDate != null and reservationDate != ''">
            AND DATE_FORMAT(start_datetime, '%Y-%m-%d') = #{reservationDate}
        </if>
        <if test="startDatetime != null and startDatetime != ''">
            AND start_datetime >= #{startDatetime}
        </if>
        <if test="endDatetime != null and endDatetime != ''">
            <![CDATA[ AND DATE_FORMAT(end_datetime, '%Y-%m-%d') < #{endDatetime} ]]>
        </if>
        ORDER BY
        r.reservation_code DESC;
    </select>

    <!-- ðŸ”¹ ê´€ë¦¬ìž: ëª¨ë“  ì˜ˆì•½ ì¡°íšŒ -->
    <select id="adminFindAllReservation" resultMap="reservationResultMap">
        SELECT
            r.reservation_code,
            r.member_code,
            CONCAT(s.store_name, '(', o.office_num, ')') AS storeName,
            r.start_datetime,
            r.end_datetime,
            r.total_price,
            r.reservation_status
        FROM
            tbl_reservation r
                JOIN tbl_office o ON r.office_code = o.office_code
                JOIN tbl_store s ON o.store_code = s.store_code
        ORDER BY
            r.reservation_code DESC;
    </select>

    <!-- ðŸ”¹ ê´€ë¦¬ìž: íŠ¹ì • ì¡°ê±´ìœ¼ë¡œ ì˜ˆì•½ ê²€ìƒ‰ -->
    <select id="searchAdminReservation" resultMap="reservationResultMap">
        SELECT
        r.reservation_code,
        r.member_code,
        CONCAT(s.store_name, '(', o.office_num, ')') AS storeName,
        r.start_datetime,
        r.end_datetime,
        r.total_price,
        r.reservation_status
        FROM
        tbl_reservation r
        JOIN tbl_office o ON r.office_code = o.office_code
        JOIN tbl_store s ON o.store_code = s.store_code
        WHERE
        1 = 1
        <if test="reservationCode != null">
            AND reservation_code = #{reservationCode}
        </if>
        <if test="memberCode != null">
            AND member_code = #{memberCode}
        </if>
        <if test="reservationDate != null and reservationDate != ''">
            AND DATE_FORMAT(start_datetime, '%Y-%m-%d') = #{reservationDate}
        </if>
        <if test="startDatetime != null and startDatetime != ''">
            AND start_datetime >= #{startDatetime}
        </if>
        <if test="endDatetime != null and endDatetime != ''">
            <![CDATA[ AND DATE_FORMAT(end_datetime, '%Y-%m-%d') < #{endDatetime} ]]>
        </if>
        ORDER BY
        r.reservation_code DESC;
    </select>

    <!-- ðŸ”¹ íšŒì› ì˜ˆì•½ ì·¨ì†Œ -->
    <update id="cancelReservationsByMember">
        UPDATE tbl_reservation
        SET reservation_status = 'ì˜ˆì•½ì·¨ì†Œ'
        WHERE reservation_code IN
        <foreach item="code" collection="reservationCodes" open="(" separator="," close=")">
            #{code}
        </foreach>
        AND member_code = #{memberCode};
    </update>

    <!-- ðŸ”¹ ê´€ë¦¬ìž: íŠ¹ì • ì˜ˆì•½ ì·¨ì†Œ -->
    <update id="cancelReservationsByAdmin">
        UPDATE tbl_reservation
        SET reservation_status = 'ì˜ˆì•½ì·¨ì†Œ'
        WHERE reservation_code IN
        <foreach item="code" collection="reservationCodes" open="(" separator="," close=")">
            #{code}
        </foreach>;
    </update>

    <!-- ðŸ”¹ ì¼ì • ê¸°ê°„ ì§€ë‚œ 'ì˜ˆì•½ì·¨ì†Œ' ìƒíƒœì˜ ì˜ˆì•½ ìžë™ ì‚­ì œ -->
    <delete id="deleteOldCanceledReservations">
        DELETE FROM tbl_reservation
        WHERE reservation_status = 'ì˜ˆì•½ì·¨ì†Œ'
          AND <![CDATA[ DATE_ADD(start_datetime, INTERVAL 30 DAY) < NOW() ]]>;
    </delete>

    <!-- ðŸ”¹ ê´€ë¦¬ìž: 'ì˜ˆì•½ì·¨ì†Œ' ìƒíƒœì¸ ì˜ˆì•½ì„ ì‚­ì œ -->
    <delete id="deleteReservations">
        DELETE FROM tbl_reservation
        WHERE reservation_code IN
        <foreach item="code" collection="reservationCodes" open="(" separator="," close=")">
            #{code}
        </foreach>
        AND reservation_status = 'ì˜ˆì•½ì·¨ì†Œ';
    </delete>

    <!-- ðŸ”¹ ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <update id="updateReservationStatus">
        UPDATE tbl_reservation 
        SET reservation_status = #{status}
        WHERE reservation_code = #{reservationCode}
    </update>

    <!-- ì˜ˆì•½ëœ ì‹œê°„ëŒ€ ì¡°íšŒ -->
    <select id="findBookedTimeSlots" resultType="string">
        SELECT DATE_FORMAT(start_datetime, '%H:00') as booked_time
        FROM tbl_reservation
        WHERE office_code = #{officeCode}
          AND DATE(start_datetime) = #{date}
          AND reservation_status != 'ì˜ˆì•½ì·¨ì†Œ'
    </select>

    <!-- ì‹œê°„ëŒ€ ì¤‘ë³µ ì²´í¬ -->
    <select id="checkTimeSlotAvailability" resultType="boolean">
        SELECT COUNT(*) = 0
        FROM tbl_reservation
        WHERE office_code = #{officeCode}
        AND reservation_status != 'ì˜ˆì•½ì·¨ì†Œ'
        AND (
            (start_datetime BETWEEN #{startDatetime} AND #{endDatetime})
            OR (end_datetime BETWEEN #{startDatetime} AND #{endDatetime})
        <![CDATA[ OR (start_datetime <= #{startDatetime} AND end_datetime >= #{endDatetime})]]>
        )
    </select>

    <!-- ì˜ˆì•½ ë“±ë¡ -->
    <insert id="insertReservation" parameterType="com.office.notfound.reservation.model.dto.ReservationDTO">
        INSERT INTO tbl_reservation (
        member_code,
        office_code,
        start_datetime,
        end_datetime,
        total_price,
        reservation_status
        ) VALUES (
        #{memberCode},
        #{officeCode},
        #{startDatetime},
        #{endDatetime},
        #{totalPrice},
        COALESCE(#{reservationStatus}, 'ì˜ˆì•½ì™„ë£Œ')
        )
    </insert>
</mapper>
